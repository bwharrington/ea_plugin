"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ShapeDataProxy = void 0;
const serializeddataerror_1 = require("../core/serializeddataerror");
const shapedatainheritance_1 = require("../core/shapedatainheritance");
const dataerror_1 = require("../data/dataerror");
const mapproxy_1 = require("./mapproxy");
/**
 * The shape data fields on a single element of the current document
 */
class ShapeDataProxy extends mapproxy_1.WriteableMapProxy {
    /**
     * @param id The ID of the element, or undefined for the document itself
     * @param client
     */
    constructor(id, client) {
        super(() => this.client.sendCommand("lsd" /* ListShapeData */, { 'id': this.id }), (name) => ShapeDataProxy.parseData(this.client.sendCommand("gsd" /* GetShapeData */, {
            'id': this.id,
            'n': name,
        })), (name, value) => {
            if ((0, serializeddataerror_1.isSerializedDataError)(value)) {
                throw new Error('Cannot store an error value');
            }
            if (this.keys().includes(name)) {
                this.client.sendCommand("ssd" /* SetShapeData */, { 'id': this.id, 'n': name, 'v': value });
            }
            else {
                this.client.sendCommand("asd" /* AddShapeData */, {
                    'id': this.id,
                    'i': shapedatainheritance_1.ShapeDataInheritance.NONE,
                    'n': name,
                    'v': value,
                });
            }
        });
        this.id = id;
        this.client = client;
    }
    /**
     * Delete the specified shape data from this element
     * @param key
     */
    delete(key) {
        if (this.keys().includes(key)) {
            this.client.sendCommand("dsd" /* DeleteShapeData */, { 'id': this.id, 'n': key });
        }
    }
    /** @ignore */
    static parseData(raw) {
        if ((0, serializeddataerror_1.isSerializedDataError)(raw)) {
            return new dataerror_1.DataError(raw['error'], raw['type']);
        }
        //TODO, eventually: parse these
        return raw;
    }
}
exports.ShapeDataProxy = ShapeDataProxy;
