"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.DocumentProxy = void 0;
const elementproxy_1 = require("./elementproxy");
const mapproxy_1 = require("./mapproxy");
const pageproxy_1 = require("./pageproxy");
/**
 * The currently-open Lucid document
 */
class DocumentProxy extends elementproxy_1.ElementProxy {
    constructor(client) {
        super(undefined, client);
        /**
         * The set of pages on this document, organized by ID
         */
        this.pages = new mapproxy_1.MapProxy(() => this.client.sendCommand("lp" /* ListPages */, undefined), (pageId) => new pageproxy_1.PageProxy(pageId, this.client));
    }
    static getNextHookName() {
        return '__documentproxy__hook' + DocumentProxy.nextHookId++;
    }
    /**
     * Add a new page to the current document
     * @param def Definition of the page to add
     * @returns The created page
     */
    addPage(def) {
        const id = this.client.sendCommand("cp" /* CreatePage */, undefined);
        const page = new pageproxy_1.PageProxy(id, this.client);
        page.setTitle(def.title);
        return page;
    }
    /**
     * Updates the title of this document
     * @param title The new title for this document
     */
    setTitle(title) {
        this.properties.set('Title', title);
    }
    /**
     * @returns The title of this document
     */
    getTitle() {
        return this.properties.get('Title');
    }
    /**
     * Watch for new blocks, lines, or groups added to this document. The callback will
     * be called with new items created by the current user, but will not be called with items
     * created
     *
     *  - As part of a generated diagram, e.g. org chart
     *  - As a result of undo or redo
     *  - By another user on the same document
     *
     * @param callback
     * @returns A handle that can be passed to `unhookCreateItems`
     */
    hookCreateItems(callback) {
        const actionName = DocumentProxy.getNextHookName();
        this.client.registerAction(actionName, (msg) => {
            callback(msg['ids'].map((id) => this.client.getItemProxy(id)));
        });
        this.client.sendCommand("hci" /* HookCreateItems */, { 'n': actionName });
        return actionName;
    }
    /**
     * @param handle Return value from `hookCreateItems`
     */
    unhookCreateItems(handle) {
        this.client.deleteAction(handle);
        this.client.sendCommand("uci" /* UnhookCreateItems */, { 'n': handle });
    }
}
exports.DocumentProxy = DocumentProxy;
DocumentProxy.nextHookId = 0;
